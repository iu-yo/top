<script>
    // ================== 新增配置部分 ================== //
    const API_BASE = 'https://api.vercel.com/v8/projects'; // [!++ 修改API端点++]
    const VERCEL_TOKEN = '你的访问令牌'; // [!++ 新增认证令牌++]

    let cachedDevices = [];

    document.addEventListener('DOMContentLoaded', function () {
        fetchDevices().catch(handleError); // [!++ 改为异步调用++]
        setInterval(() => { // [!++ 使用箭头函数避免this问题++]
            fetchDevices().catch(handleError);
        }, 10 * 60 * 1000);
    });

    // ================== 重构后的fetchDevices函数 ================== //
    async function fetchDevices() { // [!++ 改为async/await语法++]
        const tableBody = document.getElementById('deviceTableBody');
        tableBody.innerHTML = '<tr><td colspan="18" class="text-center py-4">加载中...</td></tr>';

        try {
            const response = await axios.get(API_BASE, { // [!++ 使用配置的API地址++]
                headers: { // [!++ 新增请求头++]
                    'Authorization': `Bearer ${VERCEL_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                httpAgent: new (require('http2').Http2Agent)() // [!++ 启用HTTP/2++]
            });
            
            cachedDevices = response.data.projects; // [!++ 根据API响应结构调整++]
            renderDevices(cachedDevices);
        } catch (error) {
            tableBody.innerHTML = '<tr><td colspan="18" class="text-center text-danger py-4">加载失败</td></tr>';
            throw error;
        }
    }

    // ================== 改进的renderDevices函数 ================== //
    function renderDevices(devices) {
        const tableBody = document.getElementById('deviceTableBody');
        tableBody.innerHTML = ''; // [!++ 先清空现有内容++]

        // [!++ 使用模板字符串优化可读性++]
        const rows = devices.map(device => `
            <tr>
                <td>${device.所属机构 || '-'}</td>
                <!-- 其余列保持类似结构 -->
                <td><span class="status-badge ${getStatusClass(device.设备资产状态)}">${device.设备资产状态}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary action-btn" 
                            onclick="viewDetails('${device.设备编号}')">
                        详情
                    </button>
                </td>
            </tr>
        `).join('');

        tableBody.innerHTML = rows; // [!++ 批量插入提升性能++]
    }

    // ================== 增强的辅助函数 ================== //
    function getStatusClass(status) { // [!++ 扩展状态映射++]
        const statusMap = {
            'active': 'status-active', // [!++ 适配API返回的状态值++]
            'maintenance': 'status-maintenance',
            'retired': 'status-retired'
        };
        return statusMap[status?.toLowerCase()] || '';
    }

    // [!++ 新增货币格式化函数++]
    function formatCurrency(value) {
        return value ? `¥${Number(value).toLocaleString('zh-CN')}` : '-';
    }

    // ================== 优化的搜索/筛选功能 ================== //
    function searchDevices() {
        const query = document.getElementById('searchInput').value.trim().toLowerCase();
        const filtered = cachedDevices.filter(device =>  // [!++ 使用本地缓存++]
            ['name', '设备编号'].some(key => 
                String(device[key] || '').toLowerCase().includes(query)
        );
        renderDevices(filtered);
    }

    // ================== 增强的错误处理 ================== //
    function handleError(error) { // [!++ 添加详细错误处理++]
        console.error('操作失败:', error);
        let message = '请求失败，请稍后重试';
        
        if (error.response) {
            switch (error.response.status) {
                case 401:
                    message = '认证失败，请检查访问令牌'; // [!++ 特定错误提示++]
                    break;
                case 403:
                    message = '权限不足，请联系管理员';
                    break;
                case 429:
                    message = '请求过于频繁，请稍后再试';
                    break;
            }
        }
        
        alert(`错误：${message}`);
    }
</script>
